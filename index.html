<!DOCTYPE html>
<html>
    <head>
        <title>PR Guru</title>
        <style>
            body, html { background: #555; margin: 0px; padding: 0px 0px 20px; color: #eee; height: 100%; overflow: hidden;
                font-family: Arial, Helvetica, sans-serif; }
            .pr-container { border: 1px solid rgb(201, 9, 9); border-radius: 8px 8px 24px 8px; padding: 0.5em; margin: 1em; float: left;
                min-height: 4em; min-width: 10em; visibility: hidden; position: relative; background: rgb(53, 50, 50); }
            .pr-container.show { visibility: visible; }
            .pr-container h2 { margin: 0px 0px 0.5em; }
            .pr-container > div { padding-right: 48px; }
            h1 { background: #666; margin-top: 0px; padding-top: 0.5em; }
            footer { height: 22px; padding: 3px; position: fixed; bottom: 0px; background: #666; }
            .pr-container img { height: 48px; width: 48px; border-radius:24px; border:2px solid rgb(201, 9, 9);
                position: absolute; bottom: -2px; right: -2px; box-shadow: 8px 8px 12px rgb(30,30,30); }
            #oauth2 { position:fixed; z-index: 999; top: 0px; height: 48px; width: 320px; background: rgb(30,30,30, 0.8); left: 33%; 
                border: 2px solid #555; border-top: none; border-radius: 0px 0px 8px 8px; }
            #oauth2 > div { display: table; height:24px; margin: auto; }
            #oauth2.up { top: -46px; transition: top 0.8s ease-in; }
            #oauth2 input { background: #eee; border: 2px solid #555;}
        </style>
    </head>
    <body>
        <div id="oauth2"><div><label>OAuth2 API key: <input type="text" id="oauth2-key" maxlength="42"></label></div></div>
        <h1></h1>
        <div id="main-panel"></div>
        <footer></footer>
        <template id="pr-template"><div class="pr-container"><h2>PR TITLE</h2><div>BY / WHEN</div><img/></div></template>
        <script>
        (function() {
            const REPO = window.location.hash.substr(1);
            var OAUTH2_KEY = localStorage.getItem("OAUTH2_KEY") || undefined;
            document.querySelector("h1").innerHTML = REPO;
            document.title += (" - " + REPO);

            document.querySelector("#oauth2-key").addEventListener("keypress", (event) => {
                var textBox = event.target;
                if (event.key == "Enter" && textBox.value.length > 0) {
                    OAUTH2_KEY = textBox.value;
                    localStorage.setItem("OAUTH2_KEY", textBox.value)
                    console.info("Setting Oauth2 key.");
                    document.querySelector("#oauth2").classList.add("up");
                }
            })

            function fetchPulls() {
                req = new XMLHttpRequest();
                // Add in &since=2019-04-04T00:00:00Z when we are caching results?
                req.open("GET", "https://api.github.com/repos/" + REPO + "/pulls?per_page=10", true);
                if (OAUTH2_KEY) {
                    req.setRequestHeader("Authorization", "token " + OAUTH2_KEY);
                }
                req.onreadystatechange = function() {
                    if(req.readyState === 4 && req.status === 200) {
                        var mainPanel = document.querySelector("#main-panel");
                        while (mainPanel.firstChild) {
                            mainPanel.firstChild.remove();
                        }
                        reqj = JSON.parse(req.responseText);
                        for (const pr of reqj) {
                            var prClone = document.importNode(document.querySelector("#pr-template").content, true);

                            prClone.querySelector("h2").innerHTML = pr.title;
                            prClone.querySelector("img").src = pr.user.avatar_url;
                            prClone.querySelector("div div").innerHTML = 
                                "by: " + pr.user.login
                                + "<br/>on: " + (new Date(Date.parse(pr.created_at))).toUTCString();
                            mainPanel.appendChild(prClone);
                            // If this clips the lower border of the viewport, quit the loop.
                            if (window.innerHeight - mainPanel.lastChild.getBoundingClientRect().bottom < 0) {
                                mainPanel.lastChild.remove();
                                console.warn("Quit pr display loop early due to insufficient screen space.");
                                break;
                            }
                        }
                        // Make all remaining PR boxes visible
                        document.querySelectorAll(".pr-container").forEach(prc => {prc.classList.add("show")});
                        document.querySelector("body footer").innerHTML = "Last checked: " + new Date();
                    }
                };
                req.send();
            };
            fetchPulls();
            window.setInterval(fetchPulls, 10*60*1000);
        })();
        </script>
    </body>
</html>